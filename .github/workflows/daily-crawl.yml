# .github/workflows/daily-crawl.yml
name: FDA Recall Data Daily Crawling

on:
  schedule:
    # ë§¤ì¼ ì •ì˜¤ KST (UTC 03:00)
    - cron: '0 17 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  crawl-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30ë¶„ ì œí•œ
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sqlite3
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # âœ… requirements.txt ì‚¬ìš© (ìˆìœ¼ë©´), ì—†ìœ¼ë©´ ì§ì ‘ ì„¤ì¹˜
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install playwright chromadb openai python-dotenv
        fi
        
    - name: Install Playwright browsers
      run: |
        playwright install chromium
        playwright install-deps
        
    - name: Create data directory
      run: |
        mkdir -p ./data
        
    - name: Download existing databases (if any)
      continue-on-error: true
      run: |
        # ê¸°ì¡´ DB íŒŒì¼ë“¤ì´ repositoryì— ìˆë‹¤ë©´ ë³µì‚¬
        echo "ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸ ì¤‘..."
        ls -la ./data/ || echo "ë°ì´í„° í´ë”ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
        
    - name: Run realtime crawling
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "=== FDA ì‹¤ì‹œê°„ í¬ë¡¤ë§ ì‹œì‘ ==="
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "í•œêµ­ ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')"
        
        # âœ… íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        if [ -f "fda_realtime_crawler.py" ]; then
          python fda_realtime_crawler.py
        else
          echo "âŒ fda_realtime_crawler.py íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
    - name: Check results
      run: |
        echo "=== í¬ë¡¤ë§ ê²°ê³¼ í™•ì¸ ==="
        
        # JSON íŒŒì¼ í™•ì¸
        echo "ğŸ“„ JSON íŒŒì¼ë“¤:"
        ls -la ./data/realtime_recalls_*.json 2>/dev/null || echo "   ìƒˆë¡œìš´ JSON íŒŒì¼ ì—†ìŒ"
        
        # SQLite DB í™•ì¸
        if [ -f "./data/fda_recalls.db" ]; then
          echo "âœ… SQLite DB ì¡´ì¬"
          echo "   ì´ ë ˆì½”ë“œ ìˆ˜:"
          sqlite3 ./data/fda_recalls.db "SELECT COUNT(*) as total_records FROM recalls;" 2>/dev/null || echo "   DB ì¡°íšŒ ì‹¤íŒ¨"
          echo "   ìµœê·¼ ì¶”ê°€ëœ ë°ì´í„°:"
          sqlite3 ./data/fda_recalls.db "SELECT COUNT(*) as today_records FROM recalls WHERE DATE(created_at) = DATE('now');" 2>/dev/null || echo "   ì˜¤ëŠ˜ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨"
        else
          echo "âŒ SQLite DB ì—†ìŒ"
        fi
        
        # ChromaDB í™•ì¸
        if [ -d "./data/chroma_db_recall" ]; then
          echo "âœ… ChromaDB í´ë” ì¡´ì¬"
          du -sh ./data/chroma_db_recall
        else
          echo "âŒ ChromaDB í´ë” ì—†ìŒ"
        fi
        
    - name: Commit and push updated databases
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if [[ `git status --porcelain` ]]; then
          echo "=== ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ê°ì§€ ==="
          git add ./data/
          git commit -m "ğŸ¤– Auto-update FDA recall data - $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M KST')"
          git push
          echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        else
          echo "ğŸ“‹ ìƒˆë¡œìš´ ë°ì´í„° ì—†ìŒ - ì»¤ë°‹ ìŠ¤í‚µ"
        fi
        
    - name: Notify completion
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ FDA ë¦¬ì½œ ë°ì´í„° í¬ë¡¤ë§ ì„±ê³µ!"
        else
          echo "âŒ í¬ë¡¤ë§ ì‹¤íŒ¨ - ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
        fi